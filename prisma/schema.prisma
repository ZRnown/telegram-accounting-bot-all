generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Bot {
  id             String           @id @default(cuid())
  name           String
  description    String?
  token          String
  proxyUrl       String?
  enabled        Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  welcomeMessage String?          // ğŸ”¥ æœºå™¨äººæ¬¢è¿æ¶ˆæ¯è®¾ç½®
  featureFlags   BotFeatureFlag[]
  chats          Chat[]
  chatGroups     ChatGroup[]
}

model BotFeatureFlag {
  id      String  @id @default(cuid())
  botId   String
  feature String
  enabled Boolean @default(true)
  bot     Bot     @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, feature])
}

model Chat {
  id                String            @id
  title             String?
  createdAt         DateTime          @default(now())
  status            ChatStatus        @default(PENDING)
  allowed           Boolean           @default(false)
  botId             String?
  invitedBy         String? // ğŸ”¥ æ–°å¢ï¼šé‚€è¯·äººç”¨æˆ·ID
  invitedByUsername String? // ğŸ”¥ æ–°å¢ï¼šé‚€è¯·äººç”¨æˆ·å
  groupId           String? // ğŸ”¥ æ–°å¢ï¼šåˆ†ç»„ID
  bills             Bill[]
  bot               Bot?              @relation(fields: [botId], references: [id])
  featureFlags      ChatFeatureFlag[]
  commissions       Commission[]
  dispatches        Dispatch[]
  incomes           Income[]
  operators         Operator[]
  settings          Setting?
  group             ChatGroup?        @relation(fields: [groupId], references: [id], onDelete: SetNull)
}

model ChatGroup {
  id          String   @id @default(cuid())
  botId       String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  chats       Chat[]
  bot         Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, name])
  @@index([botId])
}

model ChatFeatureFlag {
  id      String  @id @default(cuid())
  chatId  String
  feature String
  enabled Boolean @default(true)
  chat    Chat    @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([chatId, feature])
}

model Setting {
  id                         String         @id @default(cuid())
  chatId                     String         @unique
  feePercent                 Float          @default(0)
  fixedRate                  Float?
  realtimeRate               Float?
  displayMode                Int            @default(1)
  headerText                 String?
  everyoneAllowed            Boolean        @default(false)
  accountingMode             AccountingMode @default(DAILY_RESET)
  featureWarningMode         String         @default("always") // "always", "once", "daily", "silent"
  addressVerificationEnabled Boolean        @default(false) // åœ°å€éªŒè¯åŠŸèƒ½å¼€å…³
  dailyCutoffHour            Int            @default(0) // æ—¥åˆ‡æ—¶é—´ï¼ˆå°æ—¶ï¼Œ0-23ï¼‰ï¼Œé»˜è®¤0ç‚¹ï¼ˆä½¿ç”¨å…¨å±€é…ç½®ï¼Œæ­¤å¤„ä¸ºä¿ç•™å­—æ®µï¼‰
  hideHelpButton             Boolean        @default(false) // éšè—ä½¿ç”¨è¯´æ˜æŒ‰é’®
  hideOrderButton            Boolean        @default(false) // éšè—æŸ¥çœ‹å®Œæ•´è®¢å•æŒ‰é’®
  overDepositLimit           Float          @default(0) // è¶…æŠ¼æé†’é¢åº¦ï¼Œ0è¡¨ç¤ºå…³é—­æé†’
  lastOverDepositWarning     DateTime? // ä¸Šæ¬¡è¶…æŠ¼æé†’æ—¶é—´
  deleteBillConfirm          Boolean        @default(false) // ğŸ”¥ åˆ é™¤è´¦å•ç¡®è®¤åŠŸèƒ½ï¼ˆå‘é€åˆ é™¤è´¦å•åä¼šæœ‰äºŒæ¬¡ç¡®è®¤ï¼‰
  accountingEnabled          Boolean        @default(true) // ğŸ”¥ è®°è´¦åŠŸèƒ½å¼€å…³ï¼Œé»˜è®¤å¼€å¯
  calculatorEnabled          Boolean        @default(true) // ğŸ”¥ è®¡ç®—å™¨åŠŸèƒ½å¼€å…³ï¼Œé»˜è®¤å¼€å¯
  showAuthPrompt             Boolean        @default(true) // ğŸ”¥ æ˜¯å¦åœ¨è¢«æ‹‰è¿›éæˆæƒç¾¤æ—¶æ˜¾ç¤ºæˆæƒæç¤ºï¼Œé»˜è®¤å¼€å¯
  welcomeMessage             String?        // ğŸ”¥ æ–°å¢ï¼šæ‹‰ç¾¤æˆåŠŸåçš„æ¬¢è¿æ¶ˆæ¯
  authPromptMessage          String?        // ğŸ”¥ æ–°å¢ï¼šéæˆæƒç¾¤ç»„çš„è‡ªå®šä¹‰æç¤ºæ¶ˆæ¯
  chat                       Chat           @relation(fields: [chatId], references: [id])
}

model Operator {
  id       String @id @default(cuid())
  chatId   String
  username String
  chat     Chat   @relation(fields: [chatId], references: [id])

  @@unique([chatId, username])
}

model Bill {
  id       String     @id @default(cuid())
  chatId   String
  status   BillStatus @default(OPEN)
  openedAt DateTime   @default(now())
  savedAt  DateTime   @default(now())
  closedAt DateTime?
  chat     Chat       @relation(fields: [chatId], references: [id])
  items    BillItem[]
}

model BillItem {
  id         String   @id @default(cuid())
  billId     String
  type       ItemType
  amount     Float
  usdt       Float?
  rate       Float?
  feeRate    Float? // ğŸ”¥ æ–°å¢ï¼šå•ç‹¬è´¹ç‡ï¼ˆå¦‚0.95è¡¨ç¤º95%ï¼Œå³5%æ‰‹ç»­è´¹ï¼‰
  remark     String? // ğŸ”¥ æ–°å¢ï¼šå¤‡æ³¨ï¼ˆç”¨äºå¤‡æ³¨å…¥è´¦ï¼‰
  replier    String?
  operator   String?
  displayName String? // ğŸ”¥ æ–°å¢ï¼šç”¨æˆ·æ˜µç§°ï¼ˆfirst_name + last_nameï¼‰
  userId     String? // ğŸ”¥ æ–°å¢ï¼šç”¨æˆ·IDï¼ˆç”¨äºç”Ÿæˆç”¨æˆ·é“¾æ¥ï¼‰
  messageId  Int?    // ğŸ”¥ æ–°å¢ï¼šæ¶ˆæ¯IDï¼ˆç”¨äºè·³è½¬åˆ°åŸå§‹æ¶ˆæ¯ï¼‰
  createdAt  DateTime @default(now())
  bill       Bill     @relation(fields: [billId], references: [id])
}

model Income {
  id        String   @id @default(cuid())
  chatId    String
  amount    Float
  rate      Float?
  replier   String?
  operator  String?
  createdAt DateTime @default(now())
  chat      Chat     @relation(fields: [chatId], references: [id])
}

model Dispatch {
  id        String   @id @default(cuid())
  chatId    String
  amount    Float
  usdt      Float
  replier   String?
  operator  String?
  createdAt DateTime @default(now())
  chat      Chat     @relation(fields: [chatId], references: [id])
}

model Commission {
  id       String @id @default(cuid())
  chatId   String
  username String
  value    Int    @default(0)
  chat     Chat   @relation(fields: [chatId], references: [id])

  @@unique([chatId, username])
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model Admin {
  id           String?   @id @default("lower(hex(randomblob(16)))")
  username     String?   @unique(map: "sqlite_autoindex_Admin_2")
  passwordHash String?
  createdAt    DateTime? @default(now())
  updatedAt    DateTime? @default(now())

  @@ignore
}

model WhitelistedUser {
  id        String   @id @default(cuid())
  userId    String   @unique
  username  String?
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FeatureWarningLog {
  id       String   @id @default(cuid())
  chatId   String
  feature  String
  warnedAt DateTime @default(now())

  @@unique([chatId, feature])
  @@index([chatId])
}

model AddressVerification {
  id               String   @id @default(cuid())
  chatId           String   @unique // æ¯ä¸ªç¾¤åªæœ‰ä¸€æ¡è®°å½•
  confirmedAddress String? // å½“å‰ç¡®è®¤çš„åœ°å€ï¼ˆå‘é€è¿‡>=2æ¬¡ï¼‰
  confirmedCount   Int      @default(0) // ç¡®è®¤åœ°å€çš„å‘é€æ¬¡æ•°
  pendingAddress   String? // å¾…ç¡®è®¤çš„åœ°å€ï¼ˆæ–°åœ°å€ï¼Œå‘é€è¿‡1æ¬¡ï¼‰
  pendingCount     Int      @default(0) // å¾…ç¡®è®¤åœ°å€çš„å‘é€æ¬¡æ•°
  lastSenderId     String? // æœ€åå‘é€äººID
  lastSenderName   String? // æœ€åå‘é€äººåç§°
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([chatId])
}

enum ItemType {
  INCOME
  DISPATCH
}

enum BillStatus {
  OPEN
  CLOSED
}

enum AccountingMode {
  DAILY_RESET
  CARRY_OVER
  SINGLE_BILL_PER_DAY // ğŸ”¥ æ¯å¤©åªæœ‰ä¸€ç¬”è®¢å•ï¼Œä¸æ”¯æŒä¿å­˜ï¼Œä½†æ”¯æŒåˆ é™¤
}

enum ChatStatus {
  PENDING
  APPROVED
  BLOCKED
}

model GlobalConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String? // æ›´æ–°äººï¼ˆç”¨æˆ·IDæˆ–ç³»ç»Ÿï¼‰

  @@index([key])
}
