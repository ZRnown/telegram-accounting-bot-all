// æ ¸å¿ƒå‘½ä»¤å¤„ç†å™¨ï¼ˆstart, myid, help, dashboardç­‰ï¼‰
import { prisma } from '../../lib/db.js'
import { getChat } from '../state.js'
import { buildInlineKb } from '../helpers.js'

const BACKEND_URL = process.env.BACKEND_URL

/**
 * æ³¨å†Œ start å‘½ä»¤
 */
export function registerStart(bot, ensureChat) {
  bot.start(async (ctx) => {
    const userId = ctx.from?.id
    const username = ctx.from?.username ? `@${ctx.from.username}` : 'æ— '
    const firstName = ctx.from?.first_name || ''
    const lastName = ctx.from?.last_name || ''
    const fullName = `${firstName} ${lastName}`.trim()

    if (ctx.chat?.type === 'private') {
      // ðŸ”¥ ç§èŠï¼šæ£€æŸ¥æ˜¯å¦åœ¨ç™½åå•ï¼Œæ˜¾ç¤ºä¸åŒçš„æç¤ºä¿¡æ¯
      const userIdStr = String(userId || '')
      const whitelistedUser = await prisma.whitelistedUser.findUnique({
        where: { userId: userIdStr }
      })

      if (whitelistedUser) {
        // ðŸ”¥ ç™½åå•ç”¨æˆ·ï¼šæ˜¾ç¤ºç®€è¦ä¿¡æ¯ï¼Œæä¾›å†…è”èœå•
        await ctx.reply(
          `ðŸ‘¤ æ‚¨çš„ç”¨æˆ·ä¿¡æ¯ï¼š\n\n` +
          `ðŸ†” ç”¨æˆ·IDï¼š\`${userId}\`\n` +
          `ðŸ‘¤ ç”¨æˆ·åï¼š${username}\n` +
          `ðŸ“› æ˜µç§°ï¼š${fullName || 'æ— '}\n\n` +
          `âœ… æ‚¨å·²åœ¨ç™½åå•ä¸­ï¼Œå¯ä»¥é‚€è¯·æœºå™¨äººè¿›ç¾¤è‡ªåŠ¨æŽˆæƒã€‚\n\n` +
          `ðŸ’¡ ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ä½¿ç”¨ï¼š`,
          {
            parse_mode: 'Markdown',
            ...(await buildInlineKb(ctx))
          }
        )
      } else {
        // ðŸ”¥ éžç™½åå•ç”¨æˆ·ï¼šæ˜¾ç¤ºè¯¦ç»†æç¤ºä¿¡æ¯ï¼ˆåªæ˜¾ç¤ºä½¿ç”¨è¯´æ˜ŽæŒ‰é’®ï¼‰
        const { Markup } = await import('telegraf')
        const inlineKb = Markup.inlineKeyboard([
          [Markup.button.callback('ðŸ“‹ ä½¿ç”¨è¯´æ˜Ž', 'help')]
        ])

        await ctx.reply(
          `ðŸ‘¤ æ‚¨çš„ç”¨æˆ·ä¿¡æ¯ï¼š\n\n` +
          `ðŸ†” ç”¨æˆ·IDï¼š\`${userId}\`\n` +
          `ðŸ‘¤ ç”¨æˆ·åï¼š${username}\n` +
          `ðŸ“› æ˜µç§°ï¼š${fullName || 'æ— '}\n\n` +
          `æ‚¨ä¸åœ¨ç™½åå•ä¸­ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å°†æ‚¨åŠ å…¥ç™½åå•ã€‚\n\n` +
          `ðŸ’¡ ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®èŽ·å–ä½¿ç”¨è¯´æ˜Žï¼š`,
          {
            parse_mode: 'Markdown',
            ...inlineKb
          }
        )
      }
    } else {
      // ç¾¤èŠï¼šåˆå§‹åŒ–è®°è´¦
      const chat = ensureChat(ctx)
      if (!chat) return
      await ctx.reply(
        `å¼€å§‹è®°è´¦ï¼Œä½¿ç”¨ +é‡‘é¢ / -é‡‘é¢ è®°å½•å…¥æ¬¾ï¼Œä½¿ç”¨ "ä¸‹å‘é‡‘é¢" è®°å½•ä¸‹å‘ã€‚è¾“å…¥ "æ˜¾ç¤ºè´¦å•" æŸ¥çœ‹æ±‡æ€»ã€‚\n\n` +
        `ðŸ‘¤ æ‚¨çš„IDï¼š\`${userId}\` ç”¨æˆ·åï¼š${username}`,
        { ...(await buildInlineKb(ctx)), parse_mode: 'Markdown' }
      )
    }
  })
}

// ðŸ”¥ /myid å‘½ä»¤å·²åˆ é™¤ï¼Œåªä¿ç•™ä¸­æ–‡æŒ‡ä»¤

/**
 * èŽ·å–æœºå™¨äººä½¿ç”¨è¯´æ˜Žæ–‡æœ¬ï¼ˆMarkdownV2 æ ¼å¼ï¼‰
 */
function getHelpText() {
  const content = [
    '*ðŸ“– æœºå™¨äººä½¿ç”¨è¯´æ˜Ž*',
    '',
    '*ðŸ’° åŸºç¡€è®°è´¦*',
    'â€¢ å¼€å§‹ / å¼€å§‹è®°è´¦ \\- æ¿€æ´»æœºå™¨äººå¹¶å¼€å§‹è®°å½•',
    'â€¢ åœæ­¢ / åœæ­¢è®°è´¦ \\- æš‚åœæœºå™¨äººè®°å½•ï¼ˆéœ€ç®¡ç†å‘˜/æ“ä½œå‘˜æƒé™ï¼‰',
    'â€¢ \\+720 \\- è®°å½•äººæ°‘å¸æ”¶å…¥ï¼ˆ720å…ƒï¼‰',
    'â€¢ \\+100u \\- è®°å½•USDTæ”¶å…¥ï¼ˆ100Uï¼‰',
    'â€¢ \\+720/7\\.2 \\- æŒ‡å®šæ±‡çŽ‡çš„äººæ°‘å¸æ”¶å…¥',
    'â€¢ å¤‡æ³¨ \\+1000 \\- å¤‡æ³¨å…¥è´¦ï¼ˆå¤‡æ³¨å’Œé‡‘é¢ä¹‹é—´å¿…é¡»æœ‰ç©ºæ ¼ï¼Œå¦‚"å¤‡æ³¨ \\+1000"ï¼‰',
    'â€¢ æŽå››\\+10000 \\- å¤‡æ³¨å…¥è´¦ï¼ˆä¼ ç»Ÿæ ¼å¼ï¼Œåœ¨é‡‘é¢å‰åŠ å¤‡æ³¨ï¼Œå¦‚"æŽå››\\+10000"ï¼‰',
    'â€¢ \\-720 æˆ– \\-100u \\- æ’¤é”€/è´Ÿæ•°è®°å½•',
    'â€¢ ä¸‹å‘10 \\- ä¸‹å‘10ï¼ˆå½“å‰å¸ç§ï¼‰',
    'â€¢ ä¸‹å‘10u \\- ä¸‹å‘10USDT',
    'â€¢ å¤‡æ³¨ ä¸‹å‘1000 \\- å¤‡æ³¨é‡ä¸‹å‘ï¼ˆå¤‡æ³¨å’Œé‡‘é¢ä¹‹é—´å¿…é¡»æœ‰ç©ºæ ¼ï¼Œå¦‚"å¤‡æ³¨ ä¸‹å‘1000"ï¼‰',
    'â€¢ ä¸‹å‘\\-10 \\- æ’¤é”€ä¸‹å‘',
    'â€¢ æ˜¾ç¤ºè´¦å• æˆ– \\+0 \\- æŸ¥çœ‹å½“å‰è´¦å•',
    'â€¢ æ˜¾ç¤ºåŽ†å²è´¦å• \\- æŸ¥çœ‹å·²ä¿å­˜è´¦å•',
    'â€¢ æŸ¥çœ‹è´¦å• \\- æŸ¥çœ‹å®Œæ•´è´¦å•ï¼ˆåŽå°é“¾æŽ¥ï¼‰',
    'â€¢ ä½¿ç”¨è¯´æ˜Ž \\- æ˜¾ç¤ºæ­¤ä½¿ç”¨è¯´æ˜Ž',
    'â€¢ ä¿å­˜è´¦å• \\- ä¿å­˜å¹¶æ¸…ç©ºå½“å‰',
    'â€¢ åˆ é™¤è´¦å• \\- æ¸…ç©ºå½“å‰ï¼ˆä¸ä¿å­˜ï¼‰',
    'â€¢ åˆ é™¤å…¨éƒ¨è´¦å• \\- æ¸…é™¤å…¨éƒ¨è´¦å•ï¼ˆè¯·è°¨æ…Žä½¿ç”¨ï¼‰',
    'â€¢ æˆ‘çš„è´¦å• æˆ– /æˆ‘ \\- æŸ¥çœ‹è‡ªå·±çš„è®°è´¦è®°å½•ï¼ˆå«å¤‡æ³¨ï¼‰',
    'â€¢ æŒ‡å®šè´¦å• \\- å›žå¤æŒ‡å®šäººæ¶ˆæ¯ï¼Œè¾“å…¥"è´¦å•"æŸ¥çœ‹è¯¥äººè®°å½•ï¼ˆå«å¤‡æ³¨ï¼‰',
    '',
    '*ðŸŒ è´§å¸ä¸Žé‡‘é¢è§„åˆ™*',
    'â€¢ åŸºå‡†è´§å¸ï¼šUSDT\\. æ‰€æœ‰æ±‡çŽ‡åŸºäºŽ USDTâ†’å½“å‰å¸ç§',
    'â€¢ \\+100 è¡¨ç¤ºå½“å‰å¸ç§é‡‘é¢ï¼›\\+100u / \\+100usdt è¡¨ç¤º USDT é‡‘é¢',
    'â€¢ åˆ‡æ¢å¸ç§åŽï¼Œå¦‚å¯ç”¨å®žæ—¶æ±‡çŽ‡ï¼Œä¼šè‡ªåŠ¨åˆ·æ–°ä¸ºæ–°å¸ç§æ±‡çŽ‡',
    '',
    '*ðŸ§® æ•°å­¦è®¡ç®—ä¸Žè´¹çŽ‡æ±‡çŽ‡*',
    'â€¢ \\+3232\\+321 \\- æ”¯æŒåŠ æ³•è®¡ç®—ï¼ˆç»“æžœ\\+3553ï¼‰',
    'â€¢ \\+100\\-20 \\- æ”¯æŒå‡æ³•è®¡ç®—ï¼ˆç»“æžœ\\+80ï¼‰',
    'â€¢ \\+1000\\*0\\.95 \\- ä¹˜æ³•è¡¨ç¤ºè´¹çŽ‡ï¼ˆç»“æžœ\\+950å…ƒï¼Œæ‰£é™¤5%ï¼‰',
    'â€¢ \\+100/2 \\- é™¤æ³•è¡¨ç¤ºæ±‡çŽ‡ï¼ˆ100å…ƒæŒ‰æ±‡çŽ‡2è®¡ç®—ï¼Œå…¥è´¦100å…ƒï¼‰',
    'â€¢ \\+100/7\\.2 \\- æŒ‡å®šæ±‡çŽ‡7\\.2',
    'â€¢ \\+1000/7\\*0\\.95 \\- ç»„åˆï¼šæ±‡çŽ‡7å’Œè´¹çŽ‡0\\.95',
    'â€¢ 288\\-32ã€288\\*2ã€288/2ã€288\\+21 \\- æ”¯æŒæ•°å­¦è®¡ç®—ï¼ˆéœ€æ‰“å¼€è®¡ç®—å™¨åŠŸèƒ½ï¼‰',
    'â€¢ æ‰“å¼€è®¡ç®—å™¨ \\- å¯ç”¨æ•°å­¦è®¡ç®—åŠŸèƒ½',
    'â€¢ å…³é—­è®¡ç®—å™¨ \\- ç¦ç”¨æ•°å­¦è®¡ç®—åŠŸèƒ½',
    'â€¢ æ³¨ï¼š\\*è¡¨ç¤ºè´¹çŽ‡\\(0\\-1\\)ï¼Œ/è¡¨ç¤ºæ±‡çŽ‡\\(é€šå¸¸6\\-10\\)ï¼Œ\\+\\-è¡¨ç¤ºæ•°å­¦è®¡ç®—',
    '',
    '*ðŸ’± æ±‡çŽ‡ä¸Žè´¹çŽ‡*',
    'â€¢ è®¾ç½®æ±‡çŽ‡ 7\\.2 æˆ– è®¾ç½®æ±‡çŽ‡7\\.2 \\- å›ºå®šæ±‡çŽ‡ï¼ˆ1U = 7\\.2å…ƒï¼Œæ”¯æŒæœ‰æ— ç©ºæ ¼ï¼‰',
    'â€¢ è®¾ç½®å®žæ—¶æ±‡çŽ‡ \\- è‡ªåŠ¨æŠ“å–å¸‚åœºæ±‡çŽ‡ï¼ˆæ¯åŠå°æ—¶æ›´æ–°ï¼‰',
    'â€¢ åˆ·æ–°å®žæ—¶æ±‡çŽ‡ \\- æ‰‹åŠ¨æ›´æ–°å®žæ—¶æ±‡çŽ‡',
    'â€¢ æ˜¾ç¤ºå®žæ—¶æ±‡çŽ‡ \\- æŸ¥çœ‹æ±‡çŽ‡',
    'â€¢ æ˜¾ç¤ºè´§å¸ \\- æŸ¥çœ‹å½“å‰è®°è´¦å¸ç§åŠç¬¦å·',
    'â€¢ è®¾ç½®è´§å¸ USD \\- åˆ‡æ¢æœ¬ç¾¤è®°è´¦å¸ç§\\(æ”¯æŒï¼šCNY, USD, EUR, JPY, GBP, AUD, CHF, CAD, NZD, TWD, KRW, HKD\\)',
    'â€¢ z0 \\- æŸ¥è¯¢OKXå®žæ—¶Uä»·',
    'â€¢ z600u \\- ä½¿ç”¨OKXç¬¬ä¸‰ä¸ªæ±‡çŽ‡è®¡ç®—600Uå¯¹åº”çš„äººæ°‘å¸',
    'â€¢ z600 \\- ä½¿ç”¨OKXç¬¬ä¸‰ä¸ªæ±‡çŽ‡è®¡ç®—600å…ƒå¯¹åº”çš„USDT',
    'â€¢ æŸ¥è¯¢æ±‡çŽ‡ æˆ– æŸ¥è¯¢æ˜ å°„è¡¨ \\- æŸ¥çœ‹ç‚¹ä½æ±‡çŽ‡æ˜ å°„å…³ç³»',
    'â€¢ æŸ¥è¯¢æ±‡çŽ‡ 7\\.2 \\- è‡ªå®šä¹‰æŸ¥è¯¢æŒ‡å®šæ±‡çŽ‡çš„æ˜ å°„å…³ç³»',
    'â€¢ è®¾ç½®è´¹çŽ‡ 5 \\- æ‰‹ç»­è´¹5%ï¼ˆå¯é€‰ï¼‰',
    'â€¢ è®¾ç½®é¢åº¦ 10000 æˆ– è®¾ç½®é¢åº¦10000 \\- è®¾ç½®è¶…æŠ¼æé†’é¢åº¦ï¼ˆæ”¯æŒæœ‰æ— ç©ºæ ¼ï¼‰',
    '',
    '*ðŸ“Š è®°è´¦æ¨¡å¼*',
    'â€¢ è®¾ç½®è®°è´¦æ¨¡å¼ ç´¯è®¡æ¨¡å¼ \\- æœªä¸‹å‘ç´¯è®¡åˆ°æ¬¡æ—¥',
    'â€¢ è®¾ç½®è®°è´¦æ¨¡å¼ æ¸…é›¶æ¨¡å¼ \\- æ¯æ—¥ç‹¬ç«‹ï¼ˆé»˜è®¤ï¼‰',
    'â€¢ è®¾ç½®è®°è´¦æ¨¡å¼ å•ç¬”è®¢å• \\- æ¯å¤©ä¸€ç¬”è®¢å•',
    'â€¢ æŸ¥çœ‹è®°è´¦æ¨¡å¼ \\- æŸ¥çœ‹å½“å‰æ¨¡å¼',
    'â€¢ è®¾ç½®æ—¥åˆ‡æ—¶é—´ 2 \\- è®¾ç½®ä¸ºå‡Œæ™¨2ç‚¹æ—¥åˆ‡ï¼ˆç´¯è®¡æ¨¡å¼ä¸æ”¯æŒï¼‰',
    '',
    '*ðŸ“± æ˜¾ç¤ºæ¨¡å¼*',
    'â€¢ æ˜¾ç¤ºæ¨¡å¼1 \\- æœ€è¿‘3ç¬”ï¼ˆé»˜è®¤ï¼‰',
    'â€¢ æ˜¾ç¤ºæ¨¡å¼2 \\- æœ€è¿‘5ç¬”',
    'â€¢ æ˜¾ç¤ºæ¨¡å¼3 \\- ä»…æ€»è®¡',
    'â€¢ æ˜¾ç¤ºæ¨¡å¼4 \\- æœ€è¿‘10ç¬” â­',
    'â€¢ æ˜¾ç¤ºæ¨¡å¼5 \\- æœ€è¿‘20ç¬” â­',
    'â€¢ æ˜¾ç¤ºæ¨¡å¼6 \\- æ˜¾ç¤ºå…¨éƒ¨ â­',
    'â€¢ å•æ˜¾æ¨¡å¼ \\- ä»…æ˜¾ç¤ºå½“å‰å¸ç§',
    'â€¢ åŒæ˜¾æ¨¡å¼ \\- å½“å‰å¸ç§ \\| USDT',
    '',
    '*ðŸ‘¥ æƒé™ç®¡ç†*',
    'â€¢ æ·»åŠ æ“ä½œå‘˜æ–¹å¼ä¸€ï¼šæ·»åŠ æ“ä½œå‘˜ @AAA @BBB',
    'â€¢ æ·»åŠ æ“ä½œå‘˜æ–¹å¼äºŒï¼šå›žå¤æŒ‡å®šäººæ¶ˆæ¯ï¼šæ·»åŠ æ“ä½œå‘˜\\(å¯¹æ–¹æ— ç”¨æˆ·å\\)',
    'â€¢ æ·»åŠ æ“ä½œå‘˜æ–¹å¼ä¸‰ï¼šæ·»åŠ æ“ä½œå‘˜ @æ‰€æœ‰äºº\\(ç¾¤å†…æ‰€æœ‰äººéƒ½å¯ä»¥è®°è´¦\\)',
    'â€¢ åˆ é™¤æ“ä½œå‘˜æ–¹å¼ä¸€ï¼šåˆ é™¤æ“ä½œå‘˜ @AAA @BBB',
    'â€¢ åˆ é™¤æ“ä½œå‘˜æ–¹å¼äºŒï¼šå›žå¤æŒ‡å®šäººæ¶ˆæ¯ï¼šåˆ é™¤æ“ä½œå‘˜\\(å¯¹æ–¹æ— ç”¨æˆ·å\\)',
    'â€¢ æ˜¾ç¤ºæ“ä½œäºº / ç®¡ç†å‘˜ / æƒé™äºº \\- æ˜¾ç¤ºç¾¤ç»„æƒé™ä¿¡æ¯',
    'ðŸ’¡ éœ€ç¦ç”¨Privacy Modeæˆ–è®¾ä¸ºç®¡ç†å‘˜',
    'ðŸ’¡ ç®¡ç†å‘˜å’Œæ“ä½œäººå¯è®°è´¦\\!',
    '',
    '*ðŸ”§ å…¶ä»–åŠŸèƒ½*',
    'â€¢ è®¾ç½®æ ‡é¢˜ xxx \\- è‡ªå®šä¹‰è´¦å•æ ‡é¢˜',
    'â€¢ æ’¤é”€å…¥æ¬¾ \\- æ’¤é”€æœ€è¿‘ä¸€æ¡å…¥æ¬¾è®°å½•',
    'â€¢ æ’¤é”€ä¸‹å‘ \\- æ’¤é”€æœ€è¿‘ä¸€æ¡ä¸‹å‘è®°å½•',
    'â€¢ åˆ é™¤ \\- å›žå¤æŒ‡å®šè®°å½•æ¶ˆæ¯ï¼Œè¾“å…¥"åˆ é™¤"å¯åˆ é™¤è¯¥è®°å½•',
    'â€¢ ä½£é‡‘æ¨¡å¼ \\- ä½£é‡‘ç»Ÿè®¡ï¼ˆé«˜çº§ï¼‰',
    'â€¢ æ·»åŠ è‡ªå®šä¹‰æŒ‡ä»¤ è§¦å‘è¯ å†…å®¹ \\- æ–°å¢ž/ç¼–è¾‘è‡ªå®šä¹‰æ–‡æœ¬\\(ç¤ºä¾‹ï¼šæ·»åŠ è‡ªå®šä¹‰æŒ‡ä»¤ å°ååœ°å€ è¿™é‡Œæ˜¯å†…å®¹\\)',
    'â€¢ è®¾ç½®è‡ªå®šä¹‰å›¾ç‰‡ è§¦å‘è¯ å›¾ç‰‡URL \\- ä¸ºæŒ‡ä»¤è®¾ç½®å›¾ç‰‡\\(ç¤ºä¾‹ï¼šè®¾ç½®è‡ªå®šä¹‰å›¾ç‰‡ å°ååœ°å€ https://\\.\\.\\./img\\.png\\)',
    'â€¢ åˆ é™¤è‡ªå®šä¹‰æŒ‡ä»¤ è§¦å‘è¯ \\- åˆ é™¤è‡ªå®šä¹‰æŒ‡ä»¤\\(ç¤ºä¾‹ï¼šåˆ é™¤è‡ªå®šä¹‰æŒ‡ä»¤ å°ååœ°å€\\)',
    'â€¢ è‡ªå®šä¹‰æŒ‡ä»¤åˆ—è¡¨ \\- æŸ¥çœ‹æ‰€æœ‰è‡ªå®šä¹‰æŒ‡ä»¤',
    'â€¢ ç¾¤åˆ—è¡¨ \\- åˆ—å‡ºå½“å‰æœºå™¨äººæ‰€åœ¨çš„ç¾¤',
    '',
    '*ðŸš« ç¦è¨€ç®¡ç†\\(éœ€ç®¡ç†å‘˜æƒé™\\)*',
    'â€¢ ä¸Šè¯¾ / å¼€å§‹ä¸Šè¯¾ \\- æœ¬ç¾¤å·²å¼€å§‹è¥ä¸š\\(æœºå™¨äººä¸ºç®¡ç†å‘˜æ—¶æœ‰æ•ˆ\\)',
    'â€¢ ä¸‹è¯¾ \\- æœ¬ç¾¤ä»Šæ—¥å·²ä¸‹è¯¾\\(æœºå™¨äººä¸ºç®¡ç†å‘˜æ—¶æœ‰æ•ˆ\\)',
    'â€¢ è§£é™¤ç¦è¨€ / å¼€å£ \\- è§£é™¤å…¨ä½“ç¦è¨€',
    'â€¢ æŸ¥è¯¢å·¥æ—¶ \\- æŸ¥è¯¢ç´¯è®¡ä¸Šè¯¾æ—¶é•¿',
    '',
    '*ðŸ’° Uä»·æŸ¥è¯¢*',
    'â€¢ z0 \\- æŸ¥è¯¢OKXå®žæ—¶Uä»·ï¼ˆæ‰€æœ‰æ”¯ä»˜æ–¹å¼ï¼‰',
    'â€¢ z600u \\- ä½¿ç”¨OKXç¬¬ä¸‰ä¸ªæ±‡çŽ‡è®¡ç®—600Uå¯¹åº”çš„äººæ°‘å¸',
    'â€¢ z600 \\- ä½¿ç”¨OKXç¬¬ä¸‰ä¸ªæ±‡çŽ‡è®¡ç®—600å…ƒå¯¹åº”çš„USDT',
    'â€¢ lz \\- æŸ¥è¯¢OKXæ”¯ä»˜å®Uä»·',
    'â€¢ lw \\- æŸ¥è¯¢OKXå¾®ä¿¡Uä»·',
    'â€¢ lk \\- æŸ¥è¯¢OKXé“¶è¡Œå¡Uä»·',
    '',
    '*âš™ï¸ åŠŸèƒ½å¼€å…³\\(ç®¡ç†å‘˜/ç™½åå•ç”¨æˆ·\\)*',
    'â€¢ å¼€å¯æ‰€æœ‰åŠŸèƒ½ \\- å¯ç”¨æ‰€æœ‰åŠŸèƒ½å¼€å…³',
    'â€¢ å…³é—­æ‰€æœ‰åŠŸèƒ½ \\- å…³é—­æ‰€æœ‰åŠŸèƒ½å¼€å…³',
    'â€¢ å¼€å¯åœ°å€éªŒè¯ \\- å¯ç”¨é’±åŒ…åœ°å€éªŒè¯åŠŸèƒ½',
    'â€¢ å…³é—­åœ°å€éªŒè¯ \\- å…³é—­é’±åŒ…åœ°å€éªŒè¯åŠŸèƒ½',
    'â€¢ æ‰“å¼€è®¡ç®—å™¨ \\- å¯ç”¨æ•°å­¦è®¡ç®—åŠŸèƒ½ï¼ˆæ”¯æŒ288\\-32ã€288\\*2ç­‰ï¼‰',
    'â€¢ å…³é—­è®¡ç®—å™¨ \\- ç¦ç”¨æ•°å­¦è®¡ç®—åŠŸèƒ½',
    'â€¢ æœºå™¨äººé€€ç¾¤ \\- æœºå™¨äººè‡ªåŠ¨é€€ç¾¤å¹¶åˆ é™¤æ‰€æœ‰æƒé™å’Œæ•°æ®',
    'ðŸ’¡ é€‚ç”¨äºŽæœºå™¨äººåªå‘é€é€šå‘Šçš„ç¾¤ï¼Œä¸Žå…¶ä»–æœºå™¨äººäº’ä¸æ‰“æ‰°',
  ]

  return content.join('\n')
}

/**
 * æ³¨å†Œ help action
 */
export function registerHelp(bot) {
  bot.action('help', async (ctx) => {
    try {
      await ctx.answerCbQuery()
    } catch (e) {
      console.error('[help-action][answerCbQuery-error]', e)
    }

    try {
      // ðŸ”¥ ç§èŠå’Œç¾¤èŠéƒ½æ˜¾ç¤ºå®Œæ•´çš„ä½¿ç”¨è¯´æ˜Žï¼ˆMarkdownV2æ ¼å¼ï¼‰
      const help = getHelpText()
      const inlineKb = await buildInlineKb(ctx)
      await ctx.reply(help, { 
        parse_mode: 'MarkdownV2', 
        ...inlineKb 
      })
    } catch (e) {
      console.error('[help-action][reply-error]', e)
      // å¦‚æžœ MarkdownV2 å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æ™®é€šæ–‡æœ¬
      try {
    const help = getHelpText()
        // ç§»é™¤ MarkdownV2 è½¬ä¹‰å­—ç¬¦
        const plainHelp = help.replace(/\\([\\_*\[\]()~`>#+\-=|{}.!])/g, '$1')
        await ctx.reply(plainHelp, { 
          ...(await buildInlineKb(ctx))
        })
      } catch (e2) {
        console.error('[help-action][fallback-error]', e2)
        await ctx.reply('âŒ å‘é€ä½¿ç”¨è¯´æ˜Žå¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•').catch(() => {})
      }
    }
  })
}

/**
 * æ³¨å†Œä½¿ç”¨è¯´æ˜Žå‘½ä»¤
 */
export function registerHelpCommand(bot, ensureChat) {
  bot.hears(/^ä½¿ç”¨è¯´æ˜Ž$/i, async (ctx) => {
    const chat = ensureChat(ctx)
    if (!chat) return

    const help = getHelpText()
    await ctx.reply(help, { parse_mode: 'MarkdownV2', ...(await buildInlineKb(ctx)) })
  })
}

/**
 * æ³¨å†Œ open_dashboard action
 */
export function registerDashboard(bot) {
  bot.action('open_dashboard', async (ctx) => {
    try { await ctx.answerCbQuery('å·²å‘é€é“¾æŽ¥') } catch { }
    if (!BACKEND_URL) return ctx.reply('æœªé…ç½®åŽå°åœ°å€ã€‚')
    const chatId = String(ctx.chat?.id || '')
    try {
      const u = new URL(BACKEND_URL)
      u.searchParams.set('chatId', chatId)
      await ctx.reply(`æŸ¥çœ‹å®Œæ•´è®¢å•ï¼š\n${u.toString()}`)
    } catch {
      await ctx.reply(`æŸ¥çœ‹å®Œæ•´è®¢å•ï¼š\n${BACKEND_URL}`)
    }
  })
}

/**
 * æ³¨å†ŒæŸ¥çœ‹è´¦å•å‘½ä»¤ï¼ˆå‘é€è´¦å•é“¾æŽ¥ï¼‰
 */
export function registerViewBill(bot, ensureChat) {
  bot.hears(/^æŸ¥çœ‹è´¦å•$/i, async (ctx) => {
    const chat = ensureChat(ctx)
    if (!chat) return

    if (!BACKEND_URL) {
      return ctx.reply('âŒ æœªé…ç½®åŽå°åœ°å€')
    }

    const chatId = String(ctx.chat?.id || '')
    try {
      const u = new URL(BACKEND_URL)
      u.searchParams.set('chatId', chatId)
      await ctx.reply(
        `ðŸ“Š æŸ¥çœ‹å®Œæ•´è´¦å•ï¼š\n${u.toString()}`,
        { ...(await buildInlineKb(ctx)) }
      )
    } catch {
      await ctx.reply(
        `ðŸ“Š æŸ¥çœ‹å®Œæ•´è´¦å•ï¼š\n${BACKEND_URL}`,
        { ...(await buildInlineKb(ctx)) }
      )
    }
  })
}

/**
 * æ³¨å†Œ command_menu actionï¼ˆç§èŠæ—¶"æŒ‡ä»¤èœå•"æŒ‰é’®å›žè°ƒï¼‰
 */
export function registerCommandMenuAction(bot) {
  bot.action('command_menu', async (ctx) => {
    try { 
      await ctx.answerCbQuery() 
    } catch (e) {
      console.error('[command_menu][answerCbQuery]', e)
    }

    // åªåœ¨ç§èŠä¸­å¤„ç†
    if (ctx.chat?.type !== 'private') {
      return
    }

    try {
      // ðŸ”¥ å‘é€å®Œæ•´çš„ä½¿ç”¨è¯´æ˜Žï¼ˆä¸Ž help action ä¸€è‡´ï¼ŒMarkdownV2æ ¼å¼ï¼‰
      const help = getHelpText()
      const inlineKb = await buildInlineKb(ctx)
      await ctx.reply(help, { 
        parse_mode: 'MarkdownV2', 
        ...inlineKb 
      })
    } catch (e) {
      console.error('[command_menu][reply-error]', e)
      // å¦‚æžœ MarkdownV2 å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æ™®é€šæ–‡æœ¬
      try {
    const help = getHelpText()
        // ç§»é™¤ MarkdownV2 è½¬ä¹‰å­—ç¬¦
        const plainHelp = help.replace(/\\([\\_*\[\]()~`>#+\-=|{}.!])/g, '$1')
        await ctx.reply(plainHelp, { 
          ...(await buildInlineKb(ctx))
        })
      } catch (e2) {
        console.error('[command_menu][fallback-error]', e2)
        await ctx.reply('âŒ å‘é€ä½¿ç”¨è¯´æ˜Žå¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•').catch(() => {})
      }
    }
  })
}

